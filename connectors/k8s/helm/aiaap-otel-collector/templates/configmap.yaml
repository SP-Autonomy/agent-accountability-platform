apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aiaap-otel-collector.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    app: {{ include "aiaap-otel-collector.fullname" . }}
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:{{ .Values.service.otlpGrpc }}
          http:
            endpoint: 0.0.0.0:{{ .Values.service.otlpHttp }}

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 400
        spike_limit_mib: 100

      batch:
        timeout: 1s
        send_batch_size: 1024

      # Enrich spans with Kubernetes pod metadata (pod name, namespace, node, labels)
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.namespace.name
            - k8s.node.name
            - k8s.deployment.name
          labels:
            - tag_name: aiaap.k8s.app
              key: app
              from: pod
            - tag_name: aiaap.k8s.version
              key: version
              from: pod
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: connection

      # Inject tenant ID into every span
      resource:
        attributes:
          - key: aiaap.tenant.id
            value: "{{ .Values.tenantId }}"
            action: upsert

    exporters:
      # Primary: forward to AIAAP ingest service
      otlphttp:
        endpoint: {{ .Values.ingestEndpoint }}
        tls:
          insecure: {{ .Values.tls.insecure }}
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s

      # Debug: log spans to collector stdout (useful during development)
      logging:
        loglevel: {{ .Values.logLevel }}

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      pprof:
        endpoint: 0.0.0.0:1777

    service:
      extensions: [health_check, pprof]
      pipelines:
        traces:
          receivers:  [otlp]
          processors: [memory_limiter, batch, k8sattributes, resource]
          exporters:  [otlphttp, logging]
